<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Wplace管理アプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="./manifest.json" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif; margin: 16px; }
    h1 { font-size: 20px; margin: 0 0 8px; }
    h2 { font-size: 18px; margin: 0 0 8px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: .75rem .9rem; background: #fff; }
    .small { font-size: 12px; }
    .muted { color: #666; }
    .ok { color: #0a7; }
    .warn { color: #c60; }
    .err { color: #c00; }
    .kv { display:flex; gap:12px; flex-wrap:wrap; align-items:baseline; }
    .kv > div { min-width: 180px; }
    .bar { position: relative; height: 10px; background: #eee; border-radius: 999px; overflow: hidden; }
    .bar > span { position: absolute; left: 0; top: 0; bottom: 0; width: 0%; background: linear-gradient(90deg,#59f,#3bc); }
    select, input[type="text"] { padding:.4rem .5rem; border:1px solid #ccc; border-radius:8px; }
    button { padding:.45rem .7rem; border:1px solid #ccc; border-radius:8px; background:#f7f7f7; }
    button:active { transform: translateY(1px); }
    .grow { flex: 1 1 auto; min-width: 220px; }
    .sep { height:1px; background:#eee; margin:.6rem 0; }
  </style>
</head>
<body>
  <h1>Wplace 管理アプリ</h1>
  <p id="mode" class="small muted"></p>

  <!-- 通知 -->
  <div class="row" style="margin:.75rem 0">
    <button id="btnSub" type="button">通知を有効化 / 再登録</button>
    <button id="btnUnsub" type="button">購読を解除</button>
  </div>

  <!-- アカウント切替＆編集 -->
  <section class="card" style="margin:.5rem 0 1rem">
    <h2>アカウント</h2>

    <!-- 選択＆追加/削除 -->
    <div class="row" style="gap:10px; margin-top:.25rem">
      <label class="small muted">選択：</label>
      <select id="acctSelect" class="grow"></select>
      <button id="btnAcctRefresh" type="button">リスト更新</button>
    </div>
    <div class="row" style="gap:10px; margin-top:.5rem">
      <input id="newAcctId" class="grow" type="text" placeholder="新規 acctId（メールなど）">
      <input id="newAcctLabel" class="grow" type="text" placeholder="表示名（任意）">
      <button id="btnAcctAdd" type="button">追加</button>
      <button id="btnAcctDel" type="button">削除</button>
    </div>

    <div class="sep"></div>

    <!-- 既存編集 -->
    <div class="row" style="gap:10px">
      <label class="small muted">選択中の編集：</label>
      <input id="editLabel" class="grow" type="text" placeholder="表示名を編集">
      <button id="btnSaveLabel" type="button">表示名を保存</button>
    </div>
    <div class="row" style="gap:10px; margin-top:.5rem">
      <input id="editAcctId" class="grow" type="text" placeholder="新しい acctId に変更（リネーム）">
      <button id="btnRenameAcct" type="button">ID を変更</button>
    </div>

    <div class="sep"></div>

    <div class="row" style="gap:10px">
      <button id="btnSaveCred" type="button">この端末のCookieを保存</button>
    </div>

    <p class="small muted" style="margin-top:.4rem">
      ※ Cookie 保存は選択中のアカウントに対して行われます。<br>
      <code>j=...; cf_clearance=...</code> のような Cookie 全体を貼り付けてください。
    </p>
  </section>

  <!-- ステータス -->
  <section class="card">
    <h2 style="margin:0 0 .5rem 0">Wplace ステータス</h2>
    <div class="kv small">
      <div>Droplets: <strong id="droplets">-</strong></div>
      <div>Paint: <strong id="paint">-</strong>
        <span class="small muted">(チャージ <span id="charges">-</span>)</span>
      </div>
      <div>最終更新: <span id="lastUpdated" class="small muted">-</span></div>
    </div>

    <div style="margin-top:.5rem">
      <div class="bar" aria-label="charge progress"><span id="chargeBar"></span></div>
    </div>

    <div class="small" style="margin-top:.5rem">
      <div>次の1チャージ回復予定: <strong id="etaNext">-</strong></div>
      <div>満タン（全回復）予定: <strong id="etaFull">-</strong></div>
    </div>

    <div class="row" style="margin-top:.75rem">
      <button id="btnFetch" type="button">最新情報を取得</button>
      <button id="btnRunCron" type="button" title="（管理者トークンが必要）">サーバで定期チェック実行</button>
    </div>
    <p id="statusMsg" class="small muted" style="margin-top:.5rem"></p>
  </section>

  <noscript>このアプリを使うには JavaScript を有効にしてください。</noscript>

  <script type="module">
    // ===== 設定 =====
    const WORKERS_BASE = "https://wplace-push.wplace-push-rinne.workers.dev";
    const CLIENT_ID    = "01dcea86-1c4a-4d3c-9495-25559529efc0";
    const FALLBACK_ACCT_ID = "mariko09229@gmail.com";

    // ===== util =====
    const $ = (id) => document.getElementById(id);
    const mode = window.matchMedia("(display-mode: standalone)").matches ? "standalone" : "browser";
    $("mode").textContent = `[display-mode=${mode}]`;

    function setMsg(t, isErr=false) {
      const p = $("statusMsg");
      p.textContent = t || "";
      p.className = "small " + (isErr ? "err" : "muted");
      if (isErr) console.error(t); else console.log(t);
    }
    function fmtDate(ts) {
      if (!ts) return "-";
      return new Date(ts).toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" });
    }
    async function urlBase64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
      const rawData = atob(base64);
      return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
    }
    async function ensureSW() {
      if (!("serviceWorker" in navigator)) throw new Error("ServiceWorker unsupported");
      return await navigator.serviceWorker.register("./sw.js");
    }

    // ===== Push =====
    async function subscribePush() {
      try {
        const reg = await ensureSW();
        const vapidKey = await fetch(`${WORKERS_BASE}/vapid-public-key`).then(r => r.text());
        if (!vapidKey) throw new Error("VAPID 公開鍵が取得できませんでした");
        const sub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: await urlBase64ToUint8Array(vapidKey)
        });
        const res = await fetch(`${WORKERS_BASE}/push/subscribe`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ clientId: CLIENT_ID, subscription: sub })
        });
        const j = await res.json().catch(()=> ({}));
        if (!res.ok || !j.ok) throw new Error(j.error || `HTTP ${res.status}`);
        alert("通知を登録しました！（購読）");
      } catch (e) {
        alert("購読エラー: " + e.message + "\n（iOSの設定>通知 も確認）");
        console.error(e);
      }
    }
    async function unsubscribePush() {
      try {
        const reg = await ensureSW();
        const sub = await reg.pushManager.getSubscription();
        if (sub) await sub.unsubscribe();
        alert("購読を解除しました。");
      } catch (e) {
        alert("解除エラー: " + e.message);
        console.error(e);
      }
    }

    // ===== アカウント管理 =====
    let ACCT_ID = localStorage.getItem("activeAcct") || FALLBACK_ACCT_ID;
    let acctCache = []; // [{acctId,label,notify}...]

    async function loadAccounts() {
      const u = new URL(`${WORKERS_BASE}/api/accounts`);
      u.searchParams.set("clientId", CLIENT_ID);
      const res = await fetch(u.toString());
      if (!res.ok) return [];
      const j = await res.json().catch(()=>({ items:[] }));
      return Array.isArray(j.items) ? j.items : [];
    }
    function fillSelect(items) {
      const sel = $("acctSelect");
      sel.innerHTML = "";
      if (!items.length) {
        const opt = document.createElement("option");
        opt.value = ACCT_ID;
        opt.textContent = `${ACCT_ID}（未登録）`;
        sel.appendChild(opt);
        sel.value = ACCT_ID;
        $("editLabel").value = "";
        $("editAcctId").value = "";
        return;
      }
      for (const it of items) {
        const opt = document.createElement("option");
        opt.value = it.acctId;
        opt.textContent = it.label || it.acctId;
        sel.appendChild(opt);
      }
      if (!items.some(it => it.acctId === ACCT_ID)) ACCT_ID = items[0].acctId;
      sel.value = ACCT_ID;
      // 編集欄に反映
      const cur = items.find(it => it.acctId === ACCT_ID);
      $("editLabel").value = cur?.label || "";
      $("editAcctId").value = "";
    }

    async function refreshAccountList() {
      acctCache = await loadAccounts().catch(()=>[]);
      fillSelect(acctCache);
    }

    async function addAccount(acctId, label) {
      const body = { clientId: CLIENT_ID, acctId, label, notify: true };
      const res = await fetch(`${WORKERS_BASE}/api/accounts`, {
        method: "POST", headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      const j = await res.json().catch(()=> ({}));
      if (!res.ok || !j.ok) throw new Error(j.error || `HTTP ${res.status}`);
      await refreshAccountList();
      $("acctSelect").value = acctId;
      ACCT_ID = acctId;
      localStorage.setItem("activeAcct", ACCT_ID);
    }

    async function deleteAccount(acctId) {
      const body = { clientId: CLIENT_ID, acctId };
      const res = await fetch(`${WORKERS_BASE}/api/accounts`, {
        method: "DELETE", headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      const j = await res.json().catch(()=> ({}));
      if (!res.ok || !j.ok) throw new Error(j.error || `HTTP ${res.status}`);
      await refreshAccountList();
      ACCT_ID = $("acctSelect").value;
      localStorage.setItem("activeAcct", ACCT_ID);
    }

    // ★ 表示名だけ変更（PATCH /api/accounts）
    async function saveLabel(acctId, label) {
      const body = { clientId: CLIENT_ID, acctId, label };
      const res = await fetch(`${WORKERS_BASE}/api/accounts`, {
        method: "PATCH", headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      const j = await res.json().catch(()=> ({}));
      if (!res.ok || !j.ok) throw new Error(j.error || `HTTP ${res.status}`);
      await refreshAccountList();
      setMsg("表示名を更新しました。");
    }

    // ★ acctId をリネーム（PATCH /api/accounts）
    async function renameAcct(acctId, newAcctId) {
      const body = { clientId: CLIENT_ID, acctId, newAcctId };
      const res = await fetch(`${WORKERS_BASE}/api/accounts`, {
        method: "PATCH", headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      const j = await res.json().catch(()=> ({}));
      if (!res.ok || !j.ok) throw new Error(j.error || `HTTP ${res.status}`);
      await refreshAccountList();
      $("acctSelect").value = newAcctId;
      ACCT_ID = newAcctId;
      localStorage.setItem("activeAcct", ACCT_ID);
      setMsg("ACCT ID を変更しました。");
    }

    async function saveCredFromPrompt() {
      const token = prompt("Cookie 全体（例: j=...; cf_clearance=...）を貼り付け:");
      if (!token) return;
      const body = { clientId: CLIENT_ID, acctId: ACCT_ID, token };
      const res = await fetch(`${WORKERS_BASE}/api/accounts/cred`, {
        method: "POST", headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      const j = await res.json().catch(()=> ({}));
      if (!res.ok || !j.ok) throw new Error(j.error || `HTTP ${res.status}`);
      setMsg("認証情報を保存しました。");
    }

    // ===== ETA =====
    function calcEta(count, max, cooldownMs) {
      const c = Number(count ?? 0);
      const m = Number(max ?? 0);
      const cd = Number(cooldownMs ?? 0);

      if (!isFinite(c) || !isFinite(m) || m <= 0 || !isFinite(cd) || cd <= 0) {
        return { nextAt: null, fullAt: null };
      }
      if (c >= m) return { nextAt: null, fullAt: new Date() }; // すでに満タン

      const now = Date.now();

      // 次の1チャージ分：ceil(c) - c（ちょうど整数なら 1）
      const frac = c - Math.floor(c);
      const nextNeed = (frac === 0) ? 1 : (1 - frac);
      const msToNext = nextNeed * cd;
      const nextAt = new Date(now + msToNext);

      // 満タンまで：(m - c) * cd
      const msToFull = (m - c) * cd;
      const fullAt = new Date(now + msToFull);

      return { nextAt, fullAt };
    }

    function renderCharges(count, max) {
      $("charges").textContent = `${count}/${max}`;
      const ratio = !max ? 0 : Math.max(0, Math.min(1, (Number(count)||0) / (Number(max)||0)));
      $("chargeBar").style.width = `${ratio * 100}%`;
      $("paint").textContent = Number(count) >= 1 ? "ready" : "cooldown";
      $("paint").className = Number(count) >= 1 ? "ok" : "warn";
    }

    function renderEta(count, max, cooldownMs) {
      const { fullAt, nextAt } = calcEta(count, max, cooldownMs);
      if (Number(count) >= Number(max)) {
        $("etaNext").textContent = "満タンです";
        $("etaFull").textContent = "満タンです";
        return;
      }
      $("etaNext").textContent = nextAt ? nextAt.toLocaleString("ja-JP", { timeZone:"Asia/Tokyo" }) : "-";
      $("etaFull").textContent = fullAt ? fullAt.toLocaleString("ja-JP", { timeZone:"Asia/Tokyo" }) : "-";
    }

    // ===== ステータス取得 =====
    async function fetchAndRender() {
      const url  = `${WORKERS_BASE}/api/test-fetch`;
      const body = { clientId: CLIENT_ID, acctId: ACCT_ID };
      setMsg(`取得中…（acct: ${ACCT_ID}）`);
      try {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const j = await res.json();
        if (!res.ok || !j.ok) throw new Error(j.error || `HTTP ${res.status}`);

        const st = j.status || {};
        $("droplets").textContent = st.droplets ?? "-";

        const c = st.charges || {};
        const count = Number(c.count ?? 0);
        const max   = Number(c.max ?? 0);
        const cdMs  = Number(c.cooldownMs ?? 0);
        renderCharges(count, max);
        renderEta(count, max, cdMs);

        $("lastUpdated").textContent = fmtDate(Date.now());
        setMsg("取得完了");
      } catch (e) {
        setMsg("取得エラー: " + e.message, true);
      }
    }

    // ===== サーバ Cron 実行（任意）=====
    async function runCron() {
      try {
        const res = await fetch(`${WORKERS_BASE}/admin/run-cron`, { method: "POST" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        setMsg("サーバの定期チェックを実行しました。");
      } catch (e) {
        setMsg("実行エラー: " + e.message + "（管理者トークン未設定だと 401 になります）", true);
      }
    }

    // ===== イベント束ね =====
    $("btnSub").addEventListener("click", subscribePush);
    $("btnUnsub").addEventListener("click", unsubscribePush);
    $("btnFetch").addEventListener("click", fetchAndRender);
    $("btnRunCron").addEventListener("click", runCron);

    $("btnAcctRefresh").addEventListener("click", refreshAccountList);
    $("acctSelect").addEventListener("change", (e) => {
      ACCT_ID = e.target.value;
      localStorage.setItem("activeAcct", ACCT_ID);
      // 選択変更に合わせて編集欄も更新
      const cur = acctCache.find(it => it.acctId === ACCT_ID);
      $("editLabel").value = cur?.label || "";
      $("editAcctId").value = "";
      fetchAndRender();
    });

    $("btnAcctAdd").addEventListener("click", async () => {
      const acctId = $("newAcctId").value.trim();
      const label  = $("newAcctLabel").value.trim();
      if (!acctId) { alert("acctId を入力してください"); return; }
      try {
        await addAccount(acctId, label || acctId);
        $("newAcctId").value = ""; $("newAcctLabel").value = "";
        setMsg("アカウントを追加しました。");
      } catch (e) { setMsg("追加エラー: " + e.message, true); }
    });

    $("btnAcctDel").addEventListener("click", async () => {
      if (!confirm("選択中のアカウントを削除しますか？（保存済みCookieも別APIで削除推奨）")) return;
      try {
        await deleteAccount(ACCT_ID);
        setMsg("アカウントを削除しました。");
      } catch (e) { setMsg("削除エラー: " + e.message, true); }
    });

    $("btnSaveLabel").addEventListener("click", async () => {
      const label = $("editLabel").value.trim();
      try {
        await saveLabel(ACCT_ID, label || null);
      } catch (e) { setMsg("表示名更新エラー: " + e.message, true); }
    });

    $("btnRenameAcct").addEventListener("click", async () => {
      const newId = $("editAcctId").value.trim();
      if (!newId) { alert("新しい acctId を入力してください"); return; }
      if (!confirm(`acctId を "${ACCT_ID}" → "${newId}" に変更します。よろしいですか？`)) return;
      try {
        await renameAcct(ACCT_ID, newId);
        $("editAcctId").value = "";
      } catch (e) { setMsg("ID変更エラー: " + e.message, true); }
    });

    $("btnSaveCred").addEventListener("click", saveCredFromPrompt);

    // 初期化
    await refreshAccountList();
    await fetchAndRender();
  </script>
</body>
</html>
