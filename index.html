<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Wplaceç®¡ç†ã‚¢ãƒ—ãƒªï¼ˆè¨ºæ–­ç‰ˆï¼‰</title>

  <!-- iOS PWA ç”¨ -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />

  <link rel="manifest" href="./manifest.json" />
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; padding: 16px; line-height: 1.6; }
    code { background: #f3f4f6; padding: 2px 4px; border-radius: 4px; }
    .ok { color: #059669; }
    .ng { color: #dc2626; }
    .log { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background: #f9fafb; padding: 12px; border-radius: 8px; }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid #e5e7eb; background: #111827; color: #fff; }
    button + button { margin-left: 8px; }
  </style>
</head>
<body>
  <h1>Wplace ç®¡ç†ã‚¢ãƒ—ãƒªï¼ˆè¨ºæ–­ç‰ˆï¼‰</h1>

  <p>ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€<strong>èµ·å‹•ãƒ¢ãƒ¼ãƒ‰ / SWç™»éŒ² / é€šçŸ¥è¨±å¯ / å…¬é–‹éµ / Pushè³¼èª­ / ã‚µãƒ¼ãƒä¿å­˜</strong>ã®é †ã«ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚</p>

  <div style="margin: 8px 0;">
    <button onclick="run()">è¨ºæ–­ã—ã¦é€šçŸ¥ã‚’æœ‰åŠ¹åŒ–</button>
    <button onclick="resubscribe()">è³¼èª­ã‚’å†ç™»éŒ²ï¼ˆä¿®å¾©ï¼‰</button>
  </div>

  <div id="status" class="log"></div>

  <script>
    // ====== è¨­å®šï¼ˆã‚ãªãŸã®ç’°å¢ƒã«åˆã‚ã›ã¦ï¼‰ ======
    const WORKERS_BASE = "https://wplace-push.wplace-push-rinne.workers.dev";
    const VAPID_PUBLIC = "BLyGULASL4RvoJt1SQks4ODP-e0RYLWVJZ-dH9cx-_X7wXAaRQwxsquuisagpqAEs4QEJOU5e1C-UbH_hOjAfMg";
    // Service Worker ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œã‚’é¿ã‘ã‚‹ãŸã‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸Šã’ã¦ã„ã
    const SW_VERSION = "v4"; // â† è©°ã¾ã£ãŸã‚‰ v5, v6 ã¨ä¸Šã’ã‚‹
    // ===========================================

    const $ = (id) => document.getElementById(id);
    const log = (msg, ok = true) => {
      const el = $("status");
      el.innerHTML += (ok ? "âœ… " : "âŒ ") + msg + "\n";
    };
    const hr = () => { $("status").innerHTML += "-----------------------------\n"; };

    function urlBase64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
      const rawData = atob(base64);
      return Uint8Array.from([...rawData].map((c) => c.charCodeAt(0)));
    }

    async function ensureSW() {
      if (!("serviceWorker" in navigator)) {
        throw new Error("Service Worker æœªå¯¾å¿œ");
      }
      // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä»˜ãã§ç™»éŒ²ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ï¼‰
      const reg = await navigator.serviceWorker.register(`./sw.js?${SW_VERSION}`, { scope: "./" });
      await navigator.serviceWorker.ready;
      return reg;
    }

    async function requestNotifyPermission() {
      const before = Notification.permission; // default / granted / denied
      log(`é€šçŸ¥æ¨©é™ï¼ˆå‰ï¼‰: ${before}`, before !== "denied");
      const perm = await Notification.requestPermission();
      log(`é€šçŸ¥æ¨©é™ï¼ˆå¾Œï¼‰: ${perm}`, perm === "granted");
      if (perm !== "granted") throw new Error("é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸï¼ˆè¨­å®š > é€šçŸ¥ ã§è¨±å¯ï¼‰");
    }

    async function subscribeOnce() {
      const reg = await ensureSW();
      const sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC),
      });
      return sub;
    }

    async function saveSubscription(sub) {
      const res = await fetch(WORKERS_BASE + "/push/subscribe", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(sub),
        mode: "cors",
      });
      if (!res.ok) {
        const t = await res.text().catch(() => "");
        throw new Error(`ã‚µãƒ¼ãƒä¿å­˜å¤±æ•— status=${res.status} ${t}`);
      }
      return true;
    }

    async function run() {
      $("status").innerHTML = "";

      try {
        // 1) display-mode
        const standalone = window.matchMedia("(display-mode: standalone)").matches;
        log(`èµ·å‹•ãƒ¢ãƒ¼ãƒ‰: ${standalone ? "standaloneï¼ˆOKï¼‰" : "browserï¼ˆSafariã‹ã‚‰ã€‚ãƒ›ãƒ¼ãƒ ç”»é¢ã‚¢ã‚¤ã‚³ãƒ³ã§èµ·å‹•ã—ã¦ï¼‰"}`, standalone);
        if (!standalone) return; // ã“ã“ã§æ­¢ã‚ã‚‹ï¼ˆã¾ãšã¯ãƒ›ãƒ¼ãƒ ç”»é¢ã‹ã‚‰å†èµ·å‹•ï¼‰

        // 2) manifest ã¨ sw åˆ°é”æ€§ã®ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
        const mani = await fetch("./manifest.json", { cache: "no-store" });
        log(`manifestå–å¾—: ${mani.status}`, mani.ok);

        const swHead = await fetch(`./sw.js?${SW_VERSION}`, { method: "HEAD", cache: "no-store" });
        log(`sw.jsåˆ°é”: ${swHead.status}`, swHead.ok);

        // 3) Service Worker ç™»éŒ²
        const reg = await ensureSW();
        log("SWç™»éŒ²: OK", true);

        // 4) é€šçŸ¥è¨±å¯
        await requestNotifyPermission();

        // 5) VAPIDï¼ˆç›´æ›¸ãï¼‰ãƒã‚§ãƒƒã‚¯
        log(`VAPID_PUBLIC é•·ã•: ${VAPID_PUBLIC.length}`, VAPID_PUBLIC.length > 0);

        // 6) Pushè³¼èª­
        const sub = await subscribeOnce();
        log(`è³¼èª­OK: ${sub.endpoint.slice(0, 48)}...`, true);

        // 7) ã‚µãƒ¼ãƒä¿å­˜
        await saveSubscription(sub);
        log("ã‚µãƒ¼ãƒä¿å­˜: OK", true);

        hr();
        log("ğŸ‰ ã™ã¹ã¦OKï¼ PCã‹ã‚‰ /push/broadcast ã‚’å©ã„ã¦é€šçŸ¥ã‚’ç¢ºèªã—ã¦ãã ã•ã„", true);
      } catch (e) {
        log(String(e), false);
        hr();
        log("ä¸Šã®âŒã®è¡ŒãŒåŸå› ã§ã™ã€‚å¿…è¦ãªã‚‰ resubscribe ã§ä¿®å¾©ã‚’è©¦ã—ã¦ãã ã•ã„ã€‚", false);
      }
    }

    // æ—¢å­˜ã®è³¼èª­ã‚’è§£é™¤ã—ã¦ã‹ã‚‰å†ç™»éŒ²ï¼ˆendpointç„¡åŠ¹ã‚„éµä¸ä¸€è‡´ã®ä¿®å¾©ç”¨ï¼‰
    async function resubscribe() {
      $("status").innerHTML = "";
      try {
        const reg = await ensureSW();
        const old = await reg.pushManager.getSubscription();
        if (old) {
          await old.unsubscribe();
          log("æ—¢å­˜è³¼èª­: è§£é™¤ã—ã¾ã—ãŸ", true);
        } else {
          log("æ—¢å­˜è³¼èª­: è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ–°è¦ç™»éŒ²ã¸ï¼‰", true);
        }
        // å†å®Ÿè¡Œ
        await run();
      } catch (e) {
        log("å†ç™»éŒ²ã‚¨ãƒ©ãƒ¼: " + (e?.message || String(e)), false);
      }
    }
  </script>
</body>
</html>
