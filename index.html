<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Wplace管理アプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- 相対パスに注意 -->
  <link rel="manifest" href="./manifest.json" />
  <style>
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(120px,1fr));
      gap: 8px;
      margin-top: .5rem;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: .5rem .6rem;
      font-size: 14px;
      background: #fff;
    }
    .pill {
      display: inline-block;
      border: 1px solid #ddd;
      border-radius: 999px;
      padding: 2px 8px;
      margin: 2px;
      font-size: 12px;
      background: #f8f8f8;
    }
    .color-chip {
      display: inline-block;
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border: 1px solid rgba(0,0,0,.15);
      vertical-align: -2px;
      margin-right: 6px;
    }
    .palette {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(140px,1fr));
      gap: 6px;
      margin-top: .5rem;
    }
    .palette-item {
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 6px 8px;
      background: #fafafa;
      display: flex;
      align-items: center;
      gap: 8px;
      opacity: .5;            /* 未解放は薄く */
    }
    .palette-item.unlocked {
      background: #fff;
      border-color: #ddd;
      opacity: 1;             /* 解放済みははっきり */
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
    }
    .muted { color: #666; }
    .ok { color: #0a7; }
    .warn { color: #c60; }
    .err { color: #c00; }
    .small { font-size: 12px; }
    .kv { display:flex; gap:8px; flex-wrap:wrap; }
    .kv > div { min-width: 160px; }
    .bar {
      position: relative;
      height: 10px;
      background: #eee;
      border-radius: 999px;
      overflow: hidden;
    }
    .bar > span {
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 0%;
      background: linear-gradient(90deg,#59f,#3bc);
    }
  </style>
</head>
<body>
  <h1>Wplace 管理アプリ</h1>

  <!-- 表示モード確認 -->
  <p id="mode" class="small muted"></p>

  <!-- 通知操作 -->
  <div style="margin:.75rem 0; display:flex; gap:.5rem; flex-wrap:wrap">
    <button id="btnSub" type="button">通知を有効化 / 再登録</button>
    <button id="btnUnsub" type="button">購読を解除</button>
  </div>

  <!-- ステータス表示 -->
  <section class="card">
    <h2 style="margin:0 0 .5rem 0">Wplace ステータス</h2>
    <div class="kv small">
      <div>Droplets: <strong id="droplets">-</strong></div>
      <div>Paint: <strong id="paint">-</strong> <span class="small muted">(チャージ <span id="charges">-</span>)</span></div>
      <div>Colors: <strong><span id="colorsSummary">-</span></strong></div>
    </div>

    <!-- チャージ進捗バー -->
    <div style="margin-top:.5rem">
      <div class="bar" aria-label="charge progress"><span id="chargeBar"></span></div>
    </div>

    <!-- 解放済み色の名前一覧（カンマ区切り） -->
    <div id="unlockedList" class="small muted" style="margin-top:.5rem">-</div>

    <div style="margin-top:.75rem;display:flex;gap:.5rem;flex-wrap:wrap">
      <button id="btnFetch" type="button">最新情報を取得</button>
      <button id="btnSaveCred" type="button">この端末の Cookie を保存</button>
    </div>
    <p id="statusMsg" class="small muted" style="margin-top:.5rem"></p>
  </section>

  <!-- 全色パレット（解放済みはハイライト） -->
  <section class="card" style="margin-top:1rem">
    <h3 style="margin:0 0 .5rem 0">全色パレット</h3>
    <div id="palette" class="palette"></div>
  </section>

  <noscript>このアプリを使うには JavaScript を有効にしてください。</noscript>

  <!-- ES Modules -->
  <script type="module">
    // ===== 設定 =====
    const WORKERS_BASE = "https://wplace-push.wplace-push-rinne.workers.dev";
    const CLIENT_ID    = "01dcea86-1c4a-4d3c-9495-25559529efc0";
    const ACCT_ID      = "mariko09229@gmail.com";

    // 色テーブル
    import { colorNamesFromIds, COLOR_TABLE } from "./src/colors.js";

    // ===== 便利関数 =====
    const $ = (id) => document.getElementById(id);
    function setMsg(t, isErr=false) {
      const p = $("statusMsg");
      p.textContent = t || "";
      p.className = "small " + (isErr ? "err" : "muted");
      if (isErr) console.error(t); else console.log(t);
    }

    // 表示モード
    const mode = window.matchMedia("(display-mode: standalone)").matches ? "standalone" : "browser";
    $("mode").textContent = `[display-mode=${mode}]`;

    async function urlBase64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
      const rawData = atob(base64);
      return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
    }

    async function ensureSW() {
      if (!("serviceWorker" in navigator)) throw new Error("ServiceWorker unsupported");
      const reg = await navigator.serviceWorker.register("./sw.js");
      return reg;
    }

    // ===== Push購読 =====
    async function subscribePush() {
      try {
        const reg = await ensureSW();
        const vapidKey = await fetch(`${WORKERS_BASE}/vapid-public-key`).then(r => r.text());
        if (!vapidKey) throw new Error("VAPID 公開鍵が取得できませんでした");

        const sub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: await urlBase64ToUint8Array(vapidKey)
        });

        const res = await fetch(`${WORKERS_BASE}/push/subscribe`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ clientId: CLIENT_ID, subscription: sub })
        });
        const j = await res.json().catch(()=> ({}));
        if (!res.ok || !j.ok) throw new Error(j.error || `HTTP ${res.status}`);
        alert("通知を登録しました！（購読）");
      } catch (e) {
        alert("購読エラー: " + e.message + "\n（iOSの設定>通知 も確認）");
        console.error(e);
      }
    }

    async function unsubscribePush() {
      try {
        const reg = await ensureSW();
        const sub = await reg.pushManager.getSubscription();
        if (sub) await sub.unsubscribe();
        alert("購読を解除しました。");
      } catch (e) {
        alert("解除エラー: " + e.message);
        console.error(e);
      }
    }

    // ===== レンダリング補助 =====
    function renderCharges(count, max, cooldownMs) {
      $("charges").textContent = `${count}/${max}`;
      const ratio = !max ? 0 : Math.max(0, Math.min(1, count / max));
      $("chargeBar").style.width = `${ratio * 100}%`;
      $("paint").textContent = count >= 1 ? "ready" : "cooldown";
      $("paint").className = count >= 1 ? "ok" : "warn";
    }

    function renderUnlockedNames(ids) {
      const names = colorNamesFromIds(ids);
      $("unlockedList").textContent = names.length ? names.join(", ") : "-";
      $("colorsSummary").textContent = `解放済み ${names.length} / 全 ${Object.keys(COLOR_TABLE).length} 色`;
    }

    function cssColorByName(name) {
      // 名前から色コードを直には出せないので、名前をそのまま背景には使えません。
      // チップは名前を表示するだけにしておきます（必要なら別途名前→色のRGB表を作る）。
      return "#fff";
    }

    function buildPalette(unlockedSet) {
      const el = $("palette");
      el.innerHTML = "";
      // COLOR_TABLE の「id昇順」で並べる
      const allIds = Object.keys(COLOR_TABLE).map(n => Number(n)).sort((a,b)=>a-b);
      for (const id of allIds) {
        const name = COLOR_TABLE[id];
        const item = document.createElement("div");
        item.className = "palette-item" + (unlockedSet.has(id) ? " unlocked" : "");
        const chip = document.createElement("span");
        chip.className = "color-chip";
        // 任意: 名前ベースの見本色は未定義なので白いチップに（色コード表ができたら置き換え）
        chip.style.background = "#fff";
        chip.title = `id=${id}`;
        const label = document.createElement("span");
        label.textContent = `${name} (id:${id})`;
        item.appendChild(chip);
        item.appendChild(label);
        el.appendChild(item);
      }
    }

    // ===== ステータス取得 & 表示 =====
    async function fetchAndRender() {
      const url  = `${WORKERS_BASE}/api/test-fetch`;
      const body = { clientId: CLIENT_ID, acctId: ACCT_ID };
      setMsg("取得中…");
      try {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const j = await res.json();
        if (!res.ok || !j.ok) throw new Error(j.error || `HTTP ${res.status}`);

        const st = j.status || {};
        $("droplets").textContent = st.droplets ?? "-";

        // charges 表示（count/max + バー + ready/cooldown）
        const c = st.charges || {};
        renderCharges(Number(c.count ?? 0), Number(c.max ?? 0), Number(c.cooldownMs ?? 0));

        // 解放色（ID配列）→ 名前の一覧 + 全パレット
        const ids = Array.isArray(st.colors) ? st.colors : [];
        renderUnlockedNames(ids);
        buildPalette(new Set(ids));

        setMsg("取得完了");
      } catch (e) {
        setMsg("取得エラー: " + e.message, true);
      }
    }

    // Cookie 保存（任意）
    async function saveCredFromPrompt() {
      const token = prompt("Cookie 全体（例: j=...; cf_clearance=...）を貼り付け:");
      if (!token) return;
      try {
        const res = await fetch(`${WORKERS_BASE}/api/accounts/cred`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ clientId: CLIENT_ID, acctId: ACCT_ID, token })
        });
        const j = await res.json().catch(()=> ({}));
        if (!res.ok || !j.ok) throw new Error(j.error || `HTTP ${res.status}`);
        setMsg("認証情報を保存しました。");
      } catch (e) {
        setMsg("保存エラー: " + e.message, true);
      }
    }

    // クリックイベント
    $("btnSub").addEventListener("click", subscribePush);
    $("btnUnsub").addEventListener("click", unsubscribePush);
    $("btnFetch").addEventListener("click", fetchAndRender);
    $("btnSaveCred").addEventListener("click", saveCredFromPrompt);

    // 初回自動取得
    fetchAndRender();
  </script>
</body>
</html>
