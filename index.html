<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Wplace管理アプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- GitHub Pages 直下に manifest.json を置いている想定 -->
  <link rel="manifest" href="/manifest.json" />
</head>
<body>
  <h1>Wplace 管理アプリ</h1>

  <!-- 表示モード確認 -->
  <p id="mode"></p>

  <!-- 通知操作 -->
  <div style="margin:.75rem 0; display:flex; gap:.5rem; flex-wrap:wrap">
    <button id="btnSub" type="button">通知を有効化 / 再登録</button>
    <button id="btnUnsub" type="button">購読を解除</button>
  </div>

  <!-- ステータス表示 -->
  <section style="margin-top:1.5rem;padding:1rem;border:1px solid #ddd;border-radius:12px">
    <h2 style="margin:0 0 .5rem 0">Wplace ステータス</h2>
    <div id="statusBox">
      <div>Droplets: <span id="droplets">-</span></div>
      <div>Paint: <span id="paint">-</span></div>
      <div>Colors: <span id="colors">-</span></div>
    </div>
    <div style="margin-top:.75rem;display:flex;gap:.5rem;flex-wrap:wrap">
      <button id="btnFetch" type="button">最新情報を取得</button>
      <button id="btnSaveCred" type="button">この端末の Cookie を保存</button>
    </div>
    <p id="statusMsg" style="color:#555;margin-top:.5rem"></p>
  </section>

  <!-- Service Worker / Push / API 読み込み: ES Modules + 従来スクリプト -->
  <script type="module">
    import { colorNamesFromIds } from "/src/colors.js"; // ★ ここで色名テーブルを読み込み

    // ====== 設定（あなたの固有値に置き換え済み）======
    const WORKERS_BASE = "https://wplace-push.wplace-push-rinne.workers.dev";
    const CLIENT_ID    = "01dcea86-1c4a-4d3c-9495-25559529efc0";
    const ACCT_ID      = "mariko09229@gmail.com";

    // 表示モード
    const mode = window.matchMedia("(display-mode: standalone)").matches ? "standalone" : "browser";
    document.getElementById("mode").textContent = `[display-mode=${mode}]`;

    // ====== ユーティリティ ======
    function setMsg(t, isErr=false) {
      const p = document.getElementById("statusMsg");
      p.textContent = t || "";
      p.style.color = isErr ? "#c00" : "#555";
    }

    async function urlBase64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
      const rawData = atob(base64);
      return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
    }

    async function ensureSW() {
      if (!("serviceWorker" in navigator)) throw new Error("ServiceWorker unsupported");
      const reg = await navigator.serviceWorker.register("/sw.js");
      return reg;
    }

    // ====== Push 購読 ======
    async function subscribePush() {
      try {
        const reg = await ensureSW();
        // VAPID Public Key をサーバから取得（自動）
        const vapidKey = await fetch(`${WORKERS_BASE}/vapid-public-key`).then(r => r.text());
        if (!vapidKey) throw new Error("VAPID 公開鍵が取得できませんでした");
        // 購読
        const sub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: await urlBase64ToUint8Array(vapidKey)
        });
        // サーバ登録
        const res = await fetch(`${WORKERS_BASE}/push/subscribe`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ clientId: CLIENT_ID, subscription: sub })
        });
        const j = await res.json();
        if (!res.ok || !j.ok) throw new Error(j.error || res.status);
        alert("通知を登録しました！（購読）");
      } catch (e) {
        alert("購読エラー: " + e.message + "\n（iOSの設定>通知 を確認）");
      }
    }

    // 購読解除
    async function unsubscribePush() {
      try {
        const reg = await ensureSW();
        const sub = await reg.pushManager.getSubscription();
        if (sub) await sub.unsubscribe();
        alert("購読を解除しました。");
      } catch (e) {
        alert("解除エラー: " + e.message);
      }
    }

    // ====== ステータス取得 & 表示 ======
    async function fetchAndRender() {
      const url = `${WORKERS_BASE}/api/test-fetch`;
      const body = { clientId: CLIENT_ID, acctId: ACCT_ID };
      setMsg("取得中…");
      try {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const j = await res.json();
        if (!res.ok || !j.ok) throw new Error(j.error || res.status);
        const st = j.status || {};
        document.getElementById("droplets").textContent = st.droplets ?? "-";
        document.getElementById("paint").textContent    = st.paint ?? "-";
        // ★ 色ID配列 → 名前配列へ変換して表示
        document.getElementById("colors").textContent =
          Array.isArray(st.colors) ? colorNamesFromIds(st.colors).join(", ") : "-";
        setMsg("取得完了");
      } catch (e) {
        setMsg("取得エラー: " + e.message, true);
      }
    }

    // DevTools > Application > Cookies で "Cookie" を丸ごとコピーした文字列を保存するユーティリティ（任意）
    async function saveCredFromPrompt() {
      const token = prompt("Cookie 全体（例: j=...; cf_clearance=...）を貼り付け:");
      if (!token) return;
      try {
        const res = await fetch(`${WORKERS_BASE}/api/accounts/cred`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ clientId: CLIENT_ID, acctId: ACCT_ID, token })
        });
        const j = await res.json();
        if (!res.ok || !j.ok) throw new Error(j.error || res.status);
        setMsg("認証情報を保存しました。");
      } catch (e) {
        setMsg("保存エラー: " + e.message, true);
      }
    }

    // イベント紐付け
    document.getElementById("btnSub").addEventListener("click", subscribePush);
    document.getElementById("btnUnsub").addEventListener("click", unsubscribePush);
    document.getElementById("btnFetch").addEventListener("click", fetchAndRender);
    document.getElementById("btnSaveCred").addEventListener("click", saveCredFromPrompt);

    // 初回自動取得
    fetchAndRender();
  </script>
</body>
</html>
